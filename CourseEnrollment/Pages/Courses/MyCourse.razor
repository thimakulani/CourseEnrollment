@page "/my-courses"
@using MudBlazor

@inject IHttpClientService Http
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-6">

    <MudText Typo="Typo.h4" Class="mb-4">My Enrolled Courses</MudText>

    @if (_loading)
    {
        <div class="text-center">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
        </div>
    }
    else if (courses == null || !courses.Count.Equals(0) == false)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
            You are not enrolled in any courses.
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="3">
            @foreach (var c in courses)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Class="course-card">

                        <MudCardHeader>
                            <MudText Typo="Typo.h6">@c.Title</MudText>
                        </MudCardHeader>

                        <MudCardContent>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Course ID: @c.Id
                            </MudText>
                        </MudCardContent>

                        <MudCardActions>
                            <MudButton Color="Color.Error"
                                       Variant="Variant.Outlined"
                                       FullWidth="true"
                                       OnClick="@(() => ConfirmDeregister(c.Id, c.Title))">
                                Deregister
                            </MudButton>
                        </MudCardActions>

                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

</MudContainer>

@code {

    private bool _loading = true;
    private List<Course> courses = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCourses();
    }

    private async Task LoadCourses()
    {
        try
        {
            courses = await Http.GetAsync<List<Course>>("api/enrollments/student/me");
        }
        catch
        {
            Snackbar.Add("Failed to load courses.", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ConfirmDeregister(Guid id, string name)
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Deregistration",
            $"Are you sure you want to deregister from {name}?",
            yesText: "Yes",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            await Deregister(id);
        }
    }

    private async Task Deregister(Guid courseId)
    {
        try
        {
            await Http.DeleteAsync($"api/enrollments/deregister/{courseId}");
            courses.RemoveAll(x => x.Id == courseId);
            Snackbar.Add("Successfully deregistered.", Severity.Success);
        }
        catch
        {
            Snackbar.Add("Failed to deregister.", Severity.Error);
        }
    }
}

<style>
    .course-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
</style>

@page "/student/profile"
@using System.ComponentModel.DataAnnotations
@inject IHttpClientService Http
@inject NavigationManager Nav

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card shadow-lg border-0">
                <div class="card-body p-4">

                    <h3 class="card-title mb-4 text-primary">Student Profile</h3>

                    @if (_loading)
                    {
                        <div class="text-center">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    }
                    else if (_student == null)
                    {
                        <div class="alert alert-danger">
                            Unable to load student details.
                        </div>
                    }
                    else
                    {
                        <EditForm Model="_student" OnValidSubmit="UpdateStudent">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">First Name</label>
                                    <InputText class="form-control" @bind-Value="_student.Name" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Last Name</label>
                                    <InputText class="form-control" @bind-Value="_student.LastName" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <InputText class="form-control" @bind-Value="_student.Email" />
                            </div>

                            <div class="d-flex gap-2 mt-4">
                                <button type="submit" class="btn btn-primary">
                                    Update Profile
                                </button>

                                <button type="button" class="btn btn-danger" @onclick="ShowDeleteConfirm">
                                    Delete Profile
                                </button>
                            </div>
                        </EditForm>
                    }

                </div>
            </div>

        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
@if (_showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title text-danger">Confirm Delete</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>

                <div class="modal-body">
                    <p>Are you sure you want to permanently delete your profile?</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button class="btn btn-danger" @onclick="DeleteStudent">Yes, Delete</button>
                </div>

            </div>
        </div>
    </div>
}

@code {
    private Student _student;
    private bool _loading = true;
    private bool _showDeleteConfirm = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudent();
    }

    private async Task LoadStudent()
    {
        try
        {
            // Replace with your real API endpoint
            _student = await Http.GetAsync<Student>("api/account/profile");
        }
        catch
        {
            _student = null;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpdateStudent()
    {
        try
        {
            var stud = await Http.PutAsync<Student>($"api/account/update_student/{_student.Id}", _student);
            alert = "Profile updated successfully.";
            _student = stud;
        }
        catch
        {
            alert = "Failed to update profile.";
        }
    }

    private void ShowDeleteConfirm() => _showDeleteConfirm = true;

    private void CancelDelete() => _showDeleteConfirm = false;

    private async Task DeleteStudent()
    {
        try
        {
            await Http.DeleteAsync($"api/account/{_student.Id}");
            Nav.NavigateTo("/start_up");
        }
        catch
        {
            _showDeleteConfirm = false;
        }
    }

    private string alert;


}
